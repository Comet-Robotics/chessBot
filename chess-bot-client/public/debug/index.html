<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="theme-color" content="#000000" />
        <meta name="description" content="UTD ChessBots" />
        <title>UTD ChessBots Debug</title>
    </head>
    <body>
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <div id="root"></div>

        <h1>Debug Interface</h1>

        <h2 id="status"></h2>

        <h2>Control</h2>
        Target:
        <select id="robotSelectionList">
            <option>Uninitialized</option>
        </select>

        <script src="https://bobboteck.github.io/joy/joy.js"></script>
        <div
            id="joystick"
            style="width: 200px; height: 200px; margin-bottom: 20px"
        ></div>

        <script>
            const status = document.getElementById("status");
            const robotSelectionList =
                document.getElementById("robotSelectionList");
            const TIME_TO_WAIT_BETWEEN_MSGS = 50; // in ms
            let lastMessageSendTimestamp = -1;

            status.textContent = "Connecting";

            const ws = new WebSocket("ws://192.168.55.248:3000/debug/ws");

            function maintainConnection() {
                console.log("sending bot query");
                ws.send(JSON.stringify({ type: "queryBotList" }));
            }

            function handleData(e) {
                console.log("Data from server:", e.data);

                const packet = JSON.parse(e.data);

                if (packet.type === "botList") {
                    robotSelectionList.innerHTML = "";
                    for (const [key, bot] of Object.entries(packet.bots)) {
                        robotSelectionList.innerHTML += `<option value="${key}">Robot ${key} (${
                            bot.connected ? "Connected" : "Disconnected"
                        })</option>`;
                    }
                }
            }

            ws.onopen = maintainConnection;
            ws.onmessage = handleData;

            const joy = new JoyStick("joystick");
            console.log({ joy });

            setInterval(() => {
                const pos = {
                    x: joy.GetX() / 100,
                    y: joy.GetY() / 100,
                };
                //console.log(pos);
                handleMotion(pos);
            }, TIME_TO_WAIT_BETWEEN_MSGS);

            function handleMotion(pos) {
                // convert x/y positions of the joystick to left/right motor powers
                let leftMotor = pos.x + pos.y;
                let rightMotor = pos.y - pos.x;

                // clamp left/right motor powers to [-1, 1]
                const max = Math.max(Math.abs(leftMotor), Math.abs(rightMotor));
                if (max > 1.0) {
                    leftMotor /= max;
                    rightMotor /= max;
                }

                //console.log({leftMotor, rightMotor});

                leftMotor = leftMotor.toFixed(2);
                rightMotor = rightMotor.toFixed(2);

                // HTML select hypothetically supports multiple selected options, but we haven't enabled that so there should only be one option.
                const selectedBotOption = robotSelectionList.selectedOptions[0];
                const botId = selectedBotOption.value;

                sendMotorPowers(botId, leftMotor, rightMotor);
            }

            const sendMotorPowers = (robotId, leftPower, rightPower) => {
                if (ws.readyState != ws.OPEN) {
                    console.log("Websocket not open yet");
                    return;
                }

                const payload = {
                    type: "rawPacket",
                    target: parseInt(robotId),
                    contents: `:0B,${leftPower / 2},${rightPower / 2};`,
                    isDragging,
                };
                ws.send(JSON.stringify(payload));

                lastLeftPower = leftPower;
                lastRightPower = rightPower;
            };
        </script>
    </body>
</html>
